---
title: Tarjetas Guardadas
description: Guía completa para gestionar tarjetas de pago guardadas con QZPay
---

import { Steps, Aside, Tabs, TabItem } from '@astrojs/starlight/components';

# Guía de Tarjetas Guardadas

El Servicio de Tarjetas Guardadas proporciona una interfaz unificada para gestionar tarjetas de pago guardadas en diferentes proveedores de pago.

## Visión General

El servicio te permite:
- Guardar métodos de pago (tarjetas) de clientes
- Listar todas las tarjetas guardadas de un cliente
- Eliminar tarjetas guardadas
- Establecer una tarjeta como método de pago predeterminado (dependiente del proveedor)

## ¿Por Qué Usar SavedCardService?

```
┌─────────────────────────────────────────────────┐
│         Beneficios de Tarjetas Guardadas        │
├─────────────────────────────────────────────────┤
│                                                 │
│  ✓ Experiencia de pago más rápida              │
│  ✓ Mejores tasas de conversión                 │
│  ✓ Reducción de carritos abandonados           │
│  ✓ Soporte para facturación recurrente         │
│  ✓ Cumplimiento PCI manejado por el proveedor  │
│  ✓ API unificada para Stripe y MercadoPago     │
│                                                 │
└─────────────────────────────────────────────────┘
```

## Instalación

```bash
# Para Stripe
pnpm add @qazuor/qzpay-stripe

# Para MercadoPago
pnpm add @qazuor/qzpay-mercadopago
```

<Aside type="note">
Los tipos core están incluidos en `@qazuor/qzpay-core`, que se instala automáticamente como dependencia.
</Aside>

## Configuración

### Configuración de Stripe

<Steps>

1. **Crear el servicio**

   ```typescript
   import { createSavedCardService } from '@qazuor/qzpay-stripe';

   const cardService = createSavedCardService({
     provider: 'stripe',
     stripeSecretKey: process.env.STRIPE_SECRET_KEY!,
     getProviderCustomerId: async (customerId) => {
       // Resolver tu ID de cliente local al ID de cliente de Stripe
       const customer = await db.customers.findById(customerId);
       return customer.stripeCustomerId;
     },
   });
   ```

2. **Configurar Stripe.js en el frontend**

   ```javascript
   // Cargar Stripe.js
   const stripe = await loadStripe('pk_test_xxx');
   const elements = stripe.elements();
   const cardElement = elements.create('card');
   cardElement.mount('#card-element');
   ```

3. **Crear PaymentMethod en el frontend**

   ```javascript
   const { paymentMethod, error } = await stripe.createPaymentMethod({
     type: 'card',
     card: cardElement,
     billing_details: {
       name: 'Juan Pérez',
       email: 'juan@example.com',
     },
   });

   if (error) {
     console.error(error.message);
   } else {
     // Enviar paymentMethod.id al backend
     await saveCard(paymentMethod.id);
   }
   ```

</Steps>

### Configuración de MercadoPago

<Steps>

1. **Crear el servicio**

   ```typescript
   import { createSavedCardService } from '@qazuor/qzpay-mercadopago';

   const cardService = createSavedCardService({
     provider: 'mercadopago',
     mercadopagoAccessToken: process.env.MP_ACCESS_TOKEN!,
     getProviderCustomerId: async (customerId) => {
       // Resolver tu ID de cliente local al ID de cliente de MercadoPago
       const customer = await db.customers.findById(customerId);
       return customer.mercadopagoCustomerId;
     },
   });
   ```

2. **Configurar SDK de MercadoPago en el frontend**

   ```javascript
   // Inicializar SDK de MercadoPago
   const mp = new MercadoPago('PUBLIC_KEY', {
     locale: 'es-AR'
   });

   const cardForm = mp.cardForm({
     amount: "100.5",
     iframe: true,
     form: {
       id: "form-checkout",
       cardNumber: {
         id: "form-checkout__cardNumber",
         placeholder: "Número de tarjeta",
       },
       expirationDate: {
         id: "form-checkout__expirationDate",
         placeholder: "MM/AA",
       },
       securityCode: {
         id: "form-checkout__securityCode",
         placeholder: "CVV",
       },
       cardholderName: {
         id: "form-checkout__cardholderName",
         placeholder: "Titular de la tarjeta",
       },
       installments: {
         id: "form-checkout__installments",
         placeholder: "Cuotas",
       },
       identificationType: {
         id: "form-checkout__identificationType",
         placeholder: "Tipo de documento",
       },
       identificationNumber: {
         id: "form-checkout__identificationNumber",
         placeholder: "Número de documento",
       },
     },
     callbacks: {
       onFormMounted: error => {
         if (error) return console.warn("Error al montar formulario: ", error);
         console.log("Formulario montado");
       },
       onSubmit: event => {
         event.preventDefault();
         const {
           token,
           installments,
           issuerId,
           paymentMethodId,
           identificationNumber,
           identificationType,
         } = cardForm.getCardFormData();

         // Enviar token al backend
         saveCard(token);
       },
     },
   });
   ```

</Steps>

<Aside type="caution">
MercadoPago no tiene soporte nativo para métodos de pago predeterminados. Tu aplicación debe rastrear la tarjeta predeterminada por separado en tu base de datos.
</Aside>

## Uso Básico

### Guardar una Tarjeta

<Tabs>
<TabItem label="Stripe">

```typescript
const card = await cardService.save({
  customerId: 'local_cus_123',
  paymentMethodId: 'pm_xxx', // Desde Stripe.js
  setAsDefault: true,
  metadata: {
    source: 'web-app',
    savedAt: new Date().toISOString(),
  },
});

console.log('Tarjeta guardada:', {
  id: card.id,
  brand: card.brand,
  last4: card.last4,
  expiry: `${card.expMonth}/${card.expYear}`,
  isDefault: card.isDefault,
});
```

</TabItem>
<TabItem label="MercadoPago">

```typescript
const card = await cardService.save({
  customerId: 'local_cus_123',
  token: 'card_token_xxx', // Desde MercadoPago.js
  setAsDefault: true, // Rastreado en tu app, no por MP
  metadata: {
    source: 'mobile-app',
    deviceId: 'device_123',
  },
});

console.log('Tarjeta guardada:', {
  id: card.id,
  brand: card.brand,
  last4: card.last4,
  firstSixDigits: card.firstSixDigits, // Específico de MP
  expiry: `${card.expMonth}/${card.expYear}`,
});
```

</TabItem>
</Tabs>

### Listar Todas las Tarjetas

```typescript
const cards = await cardService.list('local_cus_123');

console.log(`El cliente tiene ${cards.length} tarjeta(s) guardada(s)`);

cards.forEach((card) => {
  console.log(`
    ${card.brand.toUpperCase()} •••• ${card.last4}
    Vence: ${card.expMonth}/${card.expYear}
    Predeterminada: ${card.isDefault ? 'Sí' : 'No'}
  `);
});
```

### Establecer Tarjeta Predeterminada

```typescript
// Solo soportado para Stripe
try {
  await cardService.setDefault('local_cus_123', 'pm_xxx');
  console.log('Tarjeta predeterminada actualizada');
} catch (error) {
  if (error.message.includes('not supported for mercadopago')) {
    // Manejar caso de MercadoPago - rastrear en tu base de datos
    await db.customers.update('local_cus_123', {
      defaultMercadoPagoCardId: 'card_xxx',
    });
  }
}
```

<Aside type="tip">
Para MercadoPago, rastrea el ID de tarjeta predeterminada en tu base de datos de aplicación y úsalo explícitamente al crear pagos.
</Aside>

### Eliminar una Tarjeta

```typescript
await cardService.remove('local_cus_123', 'pm_xxx');
console.log('Tarjeta eliminada exitosamente');
```

## Ejemplos de Integración Frontend

### Ejemplo Completo con Stripe

```typescript
// frontend/components/SaveCardForm.tsx
import { loadStripe } from '@stripe/stripe-js';
import { CardElement, Elements, useStripe, useElements } from '@stripe/react-stripe-js';

const stripePromise = loadStripe('pk_test_xxx');

function SaveCardForm() {
  const stripe = useStripe();
  const elements = useElements();

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();

    if (!stripe || !elements) return;

    const cardElement = elements.getElement(CardElement);
    if (!cardElement) return;

    // Crear PaymentMethod en el frontend
    const { error, paymentMethod } = await stripe.createPaymentMethod({
      type: 'card',
      card: cardElement,
      billing_details: {
        name: 'Juan Pérez',
      },
    });

    if (error) {
      console.error(error.message);
      return;
    }

    // Enviar al backend
    const response = await fetch('/api/cards/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        paymentMethodId: paymentMethod.id,
        setAsDefault: true,
      }),
    });

    if (response.ok) {
      alert('¡Tarjeta guardada exitosamente!');
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <CardElement />
      <button type="submit" disabled={!stripe}>
        Guardar Tarjeta
      </button>
    </form>
  );
}

export default function App() {
  return (
    <Elements stripe={stripePromise}>
      <SaveCardForm />
    </Elements>
  );
}
```

```typescript
// backend/routes/cards.ts
import { Hono } from 'hono';
import { cardService } from '../services/billing';
import { getSession } from '../auth';

const app = new Hono();

app.post('/save', async (c) => {
  const session = await getSession(c);
  const { paymentMethodId, setAsDefault } = await c.req.json();

  try {
    const card = await cardService.save({
      customerId: session.customerId,
      paymentMethodId,
      setAsDefault,
    });

    return c.json({ success: true, card });
  } catch (error) {
    return c.json({ error: error.message }, 400);
  }
});

export default app;
```

### Ejemplo Completo con MercadoPago

```html
<!-- frontend/save-card.html -->
<!DOCTYPE html>
<html>
<head>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body>
  <form id="form-checkout">
    <div id="form-checkout__cardNumber"></div>
    <div id="form-checkout__expirationDate"></div>
    <div id="form-checkout__securityCode"></div>
    <input type="text" id="form-checkout__cardholderName" />
    <select id="form-checkout__identificationType"></select>
    <input type="text" id="form-checkout__identificationNumber" />
    <button type="submit">Guardar Tarjeta</button>
  </form>

  <script>
    const mp = new MercadoPago('PUBLIC_KEY', { locale: 'es-AR' });

    const cardForm = mp.cardForm({
      amount: "0",
      iframe: true,
      form: {
        id: "form-checkout",
        cardNumber: { id: "form-checkout__cardNumber" },
        expirationDate: { id: "form-checkout__expirationDate" },
        securityCode: { id: "form-checkout__securityCode" },
        cardholderName: { id: "form-checkout__cardholderName" },
        identificationType: { id: "form-checkout__identificationType" },
        identificationNumber: { id: "form-checkout__identificationNumber" },
      },
      callbacks: {
        onFormMounted: error => {
          if (error) return console.warn(error);
        },
        onSubmit: async event => {
          event.preventDefault();
          const { token } = cardForm.getCardFormData();

          // Enviar al backend
          const response = await fetch('/api/cards/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token }),
          });

          if (response.ok) {
            alert('¡Tarjeta guardada exitosamente!');
          }
        },
      },
    });
  </script>
</body>
</html>
```

## Diferencias entre Proveedores

| Característica | Stripe | MercadoPago |
|---------|--------|-------------|
| Guardar tarjeta | ✅ `paymentMethodId` | ✅ `token` |
| Listar tarjetas | ✅ | ✅ |
| Eliminar tarjeta | ✅ | ✅ |
| Establecer predeterminada | ✅ Soporte nativo | ❌ Rastrear en BD de app |
| Primeros 6 dígitos | ❌ | ✅ `firstSixDigits` |
| Nombre del titular | ✅ | ✅ |

### Manejo de Tarjetas Predeterminadas

**Stripe:** Soporta nativamente métodos de pago predeterminados. Simplemente llama `setDefault()`.

**MercadoPago:** No tiene un concepto nativo de método de pago predeterminado. Tu aplicación debe:

1. Rastrear el ID de tarjeta predeterminada en tu base de datos
2. Especificar el ID de tarjeta explícitamente al crear pagos
3. No confiar en el campo `isDefault` para tarjetas de MercadoPago

```typescript
// Esquema de base de datos
interface Customer {
  id: string;
  stripeCustomerId: string;
  mercadopagoCustomerId: string;
  defaultMercadoPagoCardId?: string; // Rastrea esto
}

// Al crear un pago con MercadoPago
const customer = await db.customers.findById(customerId);
const payment = await mpAdapter.createPayment({
  amount: 1000,
  currency: 'ARS',
  customerId: customer.mercadopagoCustomerId,
  cardId: customer.defaultMercadoPagoCardId, // Especificar explícitamente
});
```

## Manejo de Errores

```typescript
try {
  const card = await cardService.save({
    customerId: 'local_cus_123',
    paymentMethodId: 'pm_invalid',
  });
} catch (error) {
  if (error.message.includes('paymentMethodId is required')) {
    // Falta parámetro requerido para Stripe
    showError('Por favor proporciona un método de pago válido');
  } else if (error.message.includes('does not belong to customer')) {
    // Intentando usar una tarjeta de otro cliente
    showError('Tarjeta inválida');
  } else if (error.message.includes('has been deleted')) {
    // El cliente ya no existe
    showError('Cliente no encontrado');
  } else if (error.message.includes('payment method has expired')) {
    // La tarjeta ha vencido
    showError('Esta tarjeta ha vencido');
  } else {
    // Error genérico
    showError('No se pudo guardar la tarjeta. Por favor intenta de nuevo.');
    console.error('Error al guardar tarjeta:', error);
  }
}
```

## Mejores Prácticas

### Seguridad

1. **Nunca envíes detalles de tarjeta sin procesar a tu backend**
   - Siempre tokeniza tarjetas en el frontend usando el SDK del proveedor
   - Solo envía tokens/IDs de PaymentMethod a tu backend

2. **Valida la propiedad del cliente**
   - El servicio valida automáticamente que las tarjetas pertenecen al cliente especificado
   - Nunca permitas que los usuarios accedan a tarjetas de otros clientes

3. **Usa HTTPS en todas partes**
   - Todas las llamadas API deben usar HTTPS en producción
   - Configura cookies seguras para autenticación

4. **Implementa rate limiting**
   - Protege los endpoints de guardar tarjetas del abuso
   - Limita intentos fallidos por usuario

### Experiencia de Usuario

1. **Muestra información clara de la tarjeta**
   - Muestra marca, últimos 4 dígitos y fecha de vencimiento
   - Indica cuál tarjeta es la predeterminada

2. **Confirma antes de eliminar**
   - Solicita confirmación antes de eliminar una tarjeta
   - Advierte si se está eliminando la tarjeta predeterminada

3. **Maneja caídas del proveedor con gracia**
   - Implementa lógica de reintento con backoff exponencial
   - Muestra mensajes de error amigables para el usuario

4. **Soporta actualizaciones de tarjeta**
   - Permite a los usuarios actualizar fechas de vencimiento
   - Proporciona una forma de manejar tarjetas vencidas

### Gestión de Datos

1. **Almacena IDs de cliente del proveedor**
   - Mantén mapeo entre tus IDs de cliente y los IDs del proveedor
   - Indexa estos campos para búsquedas rápidas

2. **Usa metadata efectivamente**
   - Rastrea cuándo y dónde se guardaron las tarjetas
   - Almacena contexto de negocio relevante

3. **Limpia tarjetas eliminadas**
   - Elimina referencias a tarjetas eliminadas de tu base de datos
   - Maneja eliminaciones en cascada apropiadamente

## Uso con Suscripciones

```typescript
// Guardar una tarjeta y crear una suscripción
async function createSubscriptionWithNewCard(
  customerId: string,
  paymentMethodId: string,
  planId: string
) {
  // 1. Guardar la tarjeta como predeterminada
  const card = await cardService.save({
    customerId,
    paymentMethodId,
    setAsDefault: true,
  });

  // 2. Crear suscripción usando la tarjeta guardada
  const subscription = await billing.subscriptions.create({
    customerId,
    planId,
    paymentMethodId: card.id,
  });

  return { card, subscription };
}

// Actualizar tarjeta predeterminada para suscripción existente
async function updateSubscriptionCard(
  subscriptionId: string,
  customerId: string,
  newPaymentMethodId: string
) {
  // 1. Guardar la nueva tarjeta como predeterminada
  await cardService.save({
    customerId,
    paymentMethodId: newPaymentMethodId,
    setAsDefault: true,
  });

  // 2. Actualizar la suscripción
  await billing.subscriptions.update(subscriptionId, {
    paymentMethodId: newPaymentMethodId,
  });
}
```

## Ver También

- [Guía de Integración con Stripe](/es/guides/stripe-integration)
- [Guía de Integración con MercadoPago](/es/guides/mercadopago-integration)
- [Ciclo de Vida de Suscripciones](/es/guides/subscription-lifecycle)
- [Manejo de Errores de Pago](/es/guides/payment-errors)
