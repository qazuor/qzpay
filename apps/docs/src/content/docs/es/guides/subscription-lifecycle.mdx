---
title: Ciclo de Vida de Suscripciones
description: Gestión del ciclo completo de suscripciones con QZPay
---

import { Steps, Aside } from '@astrojs/starlight/components';

# Guía del Ciclo de Vida de Suscripciones

Esta guía cubre la gestión de suscripciones desde la creación hasta la cancelación.

## Visión General del Ciclo de Vida

```
┌──────────────────────────────────────────────────────────────┐
│                CICLO DE VIDA DE SUSCRIPCIÓN                  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌─────────┐        ┌──────────┐        ┌────────┐         │
│   │ Creada  │───────▶│ En Prueba│───────▶│ Activa │         │
│   └─────────┘        └──────────┘        └────────┘         │
│        │                   │                  │              │
│        │                   │                  ▼              │
│        │                   │            ┌──────────┐         │
│        │                   │            │ Vencida  │         │
│        │                   │            └──────────┘         │
│        │                   │                  │              │
│        │                   ▼                  ▼              │
│        │             ┌──────────┐        ┌────────┐          │
│        └────────────▶│ Cancelada│◀───────│ Impaga │          │
│                      └──────────┘        └────────┘          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## Crear Suscripciones

### Creación Básica

```typescript
const subscription = await billing.subscriptions.create({
  customerId: 'cus_123',
  planId: 'price_pro_monthly',
  paymentMethodId: 'pm_card_visa'
});
```

### Con Período de Prueba

```typescript
const subscription = await billing.subscriptions.create({
  customerId: 'cus_123',
  planId: 'price_pro_monthly',
  trialDays: 14 // 14 días de prueba
});

// La suscripción inicia en estado 'trialing'
// No se requiere pago hasta que termine la prueba
```

### Con Código Promocional

```typescript
const subscription = await billing.subscriptions.create({
  customerId: 'cus_123',
  planId: 'price_pro_monthly',
  promoCodeId: 'LANZAMIENTO50' // 50% descuento primer mes
});
```

## Gestión de Prueba

### Verificar Estado de Prueba

```typescript
const subscription = await billing.subscriptions.get('sub_123');

if (subscription.status === 'trialing') {
  const daysLeft = Math.ceil(
    (subscription.trialEnd - Date.now()) / (1000 * 60 * 60 * 24)
  );
  console.log(`La prueba termina en ${daysLeft} días`);
}
```

### Notificación de Fin de Prueba

```typescript
billing.on('subscription.trial_ending', async (event) => {
  const { customerId, trialEnd } = event.data;

  // Enviar email recordatorio 3 días antes
  await sendEmail(customerId, 'trial_ending', {
    trialEndDate: trialEnd,
    action: 'agregar_metodo_pago'
  });
});
```

## Cambios de Plan

### Upgrade

```typescript
const subscription = await billing.subscriptions.update('sub_123', {
  planId: 'price_enterprise_monthly',
  prorationBehavior: 'create_prorations'
});

// Se cobra la diferencia prorrateada inmediatamente
// Las nuevas funcionalidades están disponibles inmediatamente
```

### Downgrade

```typescript
const subscription = await billing.subscriptions.update('sub_123', {
  planId: 'price_basic_monthly'
});
```

<Aside type="tip">
Para downgrades, considera usar el método `changePlan` que maneja el prorrateo automáticamente.
</Aside>

### Usando changePlan para Cambios de Plan

El método `changePlan()` proporciona mayor control sobre cambios de plan con cálculo automático de prorrateo:

```typescript
const result = await billing.subscriptions.changePlan('sub_123', {
  newPlanId: 'price_enterprise_monthly',
  prorationBehavior: 'create_prorations'
});

console.log('Crédito prorrateado:', result.proration?.creditAmount);
console.log('Cargo prorrateado:', result.proration?.chargeAmount);
console.log('Fecha efectiva:', result.proration?.effectiveDate);
```

#### Opciones de Comportamiento de Prorrateo

| Comportamiento | Descripción | Caso de Uso |
|----------------|-------------|-------------|
| `create_prorations` | Calcula crédito/cargo basado en tiempo restante | Predeterminado para upgrades/downgrades |
| `none` | Sin prorrateo, aplica nuevo precio inmediatamente | Pruebas gratuitas, promociones especiales |
| `always_invoice` | Siempre crea una factura para el prorrateo | Clientes enterprise, requisitos contables |

#### Opciones de Aplicación

```typescript
// Aplicar cambio inmediatamente (predeterminado)
await billing.subscriptions.changePlan('sub_123', {
  newPlanId: 'plan_pro',
  applyAt: 'immediately'
});

// Aplicar cambio al final del período de facturación actual
await billing.subscriptions.changePlan('sub_123', {
  newPlanId: 'plan_basic',
  applyAt: 'period_end'
});
```

#### Ejemplo Completo

```typescript
// Upgrade con prorrateo inmediato
const upgradeResult = await billing.subscriptions.changePlan('sub_123', {
  newPlanId: 'plan_enterprise',
  newPriceId: 'price_enterprise_monthly', // Opcional: especificar precio exacto
  prorationBehavior: 'create_prorations',
  applyAt: 'immediately'
});

if (upgradeResult.proration) {
  // Cobrar al cliente la diferencia
  if (upgradeResult.proration.chargeAmount > 0) {
    await billing.payments.process({
      customerId: upgradeResult.subscription.customerId,
      amount: upgradeResult.proration.chargeAmount,
      currency: 'USD',
      subscriptionId: upgradeResult.subscription.id,
      metadata: {
        reason: 'plan_upgrade_proration'
      }
    });
  }

  // Aplicar crédito si es downgrade
  if (upgradeResult.proration.creditAmount > 0) {
    console.log(`Crédito de ${upgradeResult.proration.creditAmount} aplicado a la cuenta`);
  }
}
```

## Pausar y Reanudar

### Pausar

```typescript
// Pausar suscripción
await billing.subscriptions.pause('sub_123');
```

### Reanudar

```typescript
await billing.subscriptions.resume('sub_123');

// El estado vuelve a 'active'
// La facturación se reanuda
```

## Cancelación

### Cancelación Inmediata

```typescript
await billing.subscriptions.cancel('sub_123', {
  atPeriodEnd: false
});

// El acceso termina inmediatamente
// Sin reembolso por defecto
```

### Cancelar al Final del Período

```typescript
await billing.subscriptions.cancel('sub_123', {
  atPeriodEnd: true
});

// El acceso continúa hasta currentPeriodEnd
// No más cargos
// El estado cambia a 'canceled' al final del período
```

### Recopilar Feedback

```typescript
billing.on('subscription.canceled', async (event) => {
  await storeCancellationData({
    subscriptionId: event.data.id,
    customerId: event.data.customerId,
    canceledAt: event.data.canceledAt,
    reason: event.data.metadata?.cancellationReason
  });

  await sendSurvey(event.data.customerId, 'cancellation');
});
```

## Manejo de Pagos Fallidos

### Estado Vencido

Cuando un pago falla, la suscripción entra en estado 'past_due':

```typescript
billing.on('payment.failed', async (event) => {
  const { subscriptionId, customerId, failureReason } = event.data;

  // Notificar al cliente
  await sendEmail(customerId, 'pago_fallido', {
    reason: failureReason,
    updatePaymentUrl: `${APP_URL}/billing/metodo-pago`
  });

  // Tracking interno
  await recordPaymentFailure(subscriptionId);
});
```

## Control de Acceso a Funcionalidades

### Basado en Estado

```typescript
function hasAccess(subscription: Subscription): boolean {
  const activeStatuses = ['active', 'trialing', 'past_due'];

  // Permitir acceso durante período de gracia
  if (subscription.status === 'canceled') {
    return subscription.currentPeriodEnd > new Date();
  }

  return activeStatuses.includes(subscription.status);
}
```

## Gestión Automatizada del Ciclo de Vida

Para aplicaciones en producción, deberías automatizar las operaciones del ciclo de vida de suscripciones usando `SubscriptionLifecycleService`.

### ¿Qué es SubscriptionLifecycleService?

El servicio de ciclo de vida orquesta el ciclo completo de suscripciones, incluyendo:

- **Renovaciones Automáticas**: Cobra y renueva suscripciones activas cuando termina su período
- **Conversiones de Prueba**: Convierte suscripciones de prueba a pagadas automáticamente
- **Reintentos de Pago**: Reintenta pagos fallidos según un calendario configurado
- **Cancelaciones Automáticas**: Cancela suscripciones después de que expire el período de gracia

### Configuración

```typescript
import { createSubscriptionLifecycle } from '@qazuor/qzpay-core';

const lifecycle = createSubscriptionLifecycle(billing, storage, {
  gracePeriodDays: 7,
  retryIntervals: [1, 3, 5], // Reintentar después de 1, 3 y 5 días
  trialConversionDays: 0,

  processPayment: async (input) => {
    // Procesar pago con tu proveedor
    const result = await stripe.paymentIntents.create({
      amount: input.amount,
      currency: input.currency,
      customer: providerCustomerId,
      payment_method: input.paymentMethodId,
      confirm: true,
    });

    return {
      success: result.status === 'succeeded',
      paymentId: result.id,
    };
  },

  getDefaultPaymentMethod: async (customerId) => {
    const pm = await storage.paymentMethods.findDefaultByCustomerId(customerId);
    return pm ? { id: pm.id, providerPaymentMethodId: pm.stripePaymentMethodId } : null;
  },

  onEvent: async (event) => {
    // Manejar eventos del ciclo de vida
    console.log(`[Lifecycle] ${event.type}`, event);

    switch (event.type) {
      case 'subscription.renewal_failed':
        await sendEmail(event.customerId, 'pago_fallido');
        break;
      case 'subscription.trial_converted':
        await sendEmail(event.customerId, 'prueba_convertida');
        break;
      case 'subscription.canceled_nonpayment':
        await sendEmail(event.customerId, 'suscripcion_cancelada');
        break;
    }
  },
});
```

### Ejecutando en un Cron Job

Procesa todas las operaciones del ciclo de vida en un calendario regular:

```typescript
import cron from 'node-cron';

// Ejecutar cada hora
cron.schedule('0 * * * *', async () => {
  console.log('Procesando ciclo de vida de suscripciones...');

  const results = await lifecycle.processAll();

  console.log({
    renovaciones: results.renewals.succeeded,
    conversiones: results.trialConversions.succeeded,
    reintentos: results.retries.succeeded,
    cancelaciones: results.cancellations.processed,
  });
});
```

### Opciones de Configuración

| Opción | Descripción | Ejemplo |
|--------|-------------|---------|
| `gracePeriodDays` | Días antes de cancelar por pago fallido | 7 |
| `retryIntervals` | Días entre reintentos de pago | `[1, 3, 5]` |
| `trialConversionDays` | Días antes del fin de prueba para intentar conversión | 0 |
| `processPayment` | Función para procesar pago con el proveedor | Ver arriba |
| `getDefaultPaymentMethod` | Función para obtener método de pago predeterminado | Ver arriba |
| `onEvent` | Callback opcional para eventos del ciclo de vida | Ver arriba |

### Eventos del Ciclo de Vida

El servicio emite eventos para todas las operaciones:

**Eventos de Renovación:**
- `subscription.renewed`: Renovada exitosamente
- `subscription.renewal_failed`: Pago de renovación fallido
- `subscription.entered_grace_period`: Entró en período de gracia

**Eventos de Conversión de Prueba:**
- `subscription.trial_converted`: Prueba convertida a pagada
- `subscription.trial_conversion_failed`: Conversión de prueba fallida

**Eventos de Reintento:**
- `subscription.retry_scheduled`: Reintento de pago programado
- `subscription.retry_succeeded`: Reintento exitoso
- `subscription.retry_failed`: Reintento fallido

**Eventos de Cancelación:**
- `subscription.canceled_nonpayment`: Cancelada por falta de pago

### Con Jobs en Background

Usa un sistema de colas para procesamiento más robusto:

```typescript
import { Queue, Worker } from 'bullmq';

const connection = { host: 'localhost', port: 6379 };

// Programar job
const lifecycleQueue = new Queue('subscription-lifecycle', { connection });

await lifecycleQueue.add(
  'process-all',
  {},
  {
    repeat: {
      pattern: '0 * * * *', // Cada hora
    },
  }
);

// Procesar job
const worker = new Worker(
  'subscription-lifecycle',
  async (job) => {
    const results = await lifecycle.processAll();
    return results;
  },
  { connection }
);

worker.on('completed', (job, result) => {
  console.log(`Procesamiento de ciclo de vida completado`, result);
});
```

### Estrategias de Reintento

Configura intervalos de reintento según las necesidades de tu negocio:

**Agresiva (Clientes de alto valor):**
```typescript
gracePeriodDays: 14,
retryIntervals: [1, 2, 3, 5, 7, 10], // 6 reintentos en 28 días
```

**Balanceada (Estándar):**
```typescript
gracePeriodDays: 7,
retryIntervals: [1, 3, 5], // 3 reintentos en 9 días
```

**Leniente (Enterprise):**
```typescript
gracePeriodDays: 30,
retryIntervals: [3, 7, 14, 21], // 4 reintentos en 45 días
```

## Mejores Prácticas

1. **Siempre usa `atPeriodEnd: true`** para cancelaciones a menos que se solicite explícitamente
2. **Envía notificaciones proactivas** para fin de prueba, pago fallido
3. **Implementa períodos de gracia** para reducir churn involuntario
4. **Rastrea razones de cancelación** para mejorar tu producto
5. **Permite reactivación** dentro de una ventana razonable
6. **Automatiza operaciones del ciclo de vida** usando SubscriptionLifecycleService
7. **Monitorea eventos del ciclo de vida** y responde apropiadamente
8. **Configura estrategias de reintento** según tu modelo de negocio
9. **Prueba exhaustivamente** con diferentes escenarios antes de producción
